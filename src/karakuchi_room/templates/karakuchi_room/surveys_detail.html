{% extends "base.html" %}

{% block content %}

<div class="header page-title my-4">
    <h2>{{ survey.title }}</h2>
</div>
<div class="selcted-tags w-100 mx-auto py-2 row">
    {% comment %}{{ for タグ表示 }}{% endcomment %}
    <div class="col-auto me-2 mb-2 bg-secondary-subtle rounded-5">{{ タグ }}</div>
    {% comment %}{{ endfor タグ表示 }}{% endcomment %}
</div>
<div class="row mb-2">
    {% comment %} <span class="col-auto">{{ survey.start_at }}</span> {% endcomment %}
    <span class="col-auto">期限: {{ survey.end_at }}まで</span>
</div>
{% comment %} アンケート作成者本人の場合 {% endcomment %}
{% if survey.user == request.user %}
<div class="d-flex justify-content-between">
    {% comment %}
    <div>
        <span class="col-auto">23 votes</span>
    </div>
    {% endcomment %}
    <div>
        {% if survey.is_public %}
        <a href="{% url 'survey-edit' survey.pk %}">編集</a>
        {% else %}
        <a href="{% url 'survey-temporary-edit' survey.pk %}">編集</a>
        {% endif %}
        <a href="{% url 'survey-delete' survey.pk %}">削除</a>
    </div>
</div>
{% endif %}
{% comment %} アンケート作成者で本人ではない場合 {% endcomment %}
{% comment %} <div class="d-flex justify-content-end">
    <span class="col-auto">2026/1/20</span>
</div> {% endcomment %}
<div class="discription border border-secondary p-2 my-3">
    {% if survey.description %}
    <p>{{ survey.description }}</p>
    {% else %}
    <p>アンケートの詳細説明はありません</p>
    {% endif %}
</div>
{% comment %} 円グラフ chart.jsで実装する {% endcomment %}
<div class="m-3 p-3">
    {% for option in option_list %}
    {{ option.label }}
    {% endfor %}
    <canvas id="chart" width="400" hight="400" 
        {% for oc in option_vote_counts %}
        data-{{ oc.label|slugify }}="{{ oc.vote_count }}"
        {% endfor %}
    ></canvas>
</div>
{% comment %} ユーザーが投票している場合、表示 {% endcomment %}
<div>
    {% if vote and vote.pk %}
    <p>
        <a href="{% url 'vote-detail' vote.pk %}">投票詳細へ</a>
    </p>
    {% else %}
    <p>まだ投票していません。</p>
    {% endif %}
</div>
{% comment %} ユーザーが投票している場合、表示 ここまで{% endcomment %}
<div class="comment-list">
    <div>
        <h4>みんなのコメント</h4>
    </div>
    <ul class="list-unstyled">
        <li>
            <div class="card p-3">
                <div class="d-flex">
                    {% comment %} 円グラフの凡例に色をあわせる {% endcomment %}
                    <div class="text-primary me-2">
                        <span>■</span>
                    </div>

                    {% comment %} 全てのコメント一覧 {% endcomment %}
                    {% if vote_list %}
                    <ul>
                        {% for all_comment in vote_list %}
                        <li class="mb-2">
                            「{{ all_comment.comment|default:"（コメントなし）" }}」<br>
                            選択肢：{{ all_comment.option.label }}<br>
                            投稿日時：{{ all_comment.created_at|date:"Y-m-d H:i" }}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p>まだコメント付きの投票はありません。</p>
                    {% endif %}
                </div>
                <hr>
                {% comment %} 選択肢の票数を集計 {% endcomment %}
                {% if option_vote_counts %}
                <table class="table">
                    <thead>
                        <tr>
                            <th>選択肢</th>
                            <th>票数</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for count in option_vote_counts %}
                        <tr>
                            <td>{{ count.label }}</td>
                            <td>{{ count.vote_count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p>まだ有効な投票はありません。</p>
                {% endif %}
                {% comment %} 投票者本人の場合 {% endcomment %}
                <div>
                    {% comment %} 複数のテーブルが関係する場合のカラムの表示方法 {% endcomment %}
                    <p>選んだ選択肢：{{ vote.option.label }}</p>

                    <p>コメント：{{ vote.comment }}</p>
                </div>
                <div class="d-flex justify-content-end">
                    <div>
                        <span class="col-auto">{{ survey.end_at }}</span>
                    </div>
                </div>
            </div>
        </li>
    </ul>
</div>

{% endblock content %}