{% extends "base.html" %}

{% block content %}

<div class="text-center p-3">
    <a href="{% url 'survey-create'%}" class="btn btn-success btn-lg">アンケートを作成する！</a>
</div>
<div class="header page-title my-4">
    <h2>アンケート一覧</h2>
</div>
<div class="search-bar w-100 mx-auto p-2">
    {% comment %} 検索バー {% endcomment %}
    <form action="" method="get">
        <div class="row mb-3">
            {% comment %} しほ：ここからキーワド検索とタグ検索 {% endcomment %}
            <input class="form-control col" type="text" name="q" placeholder="Search" value="{{ request.GET.p }}">
            <button class="col-auto btn btn-light" type="submit">検索</button>
        </div>

        {% comment %} 検索バー　ここまで {% endcomment %}
    </div>
    {% comment %} チェックボックス {% endcomment %}
    <div>
        <div class="form-check mb-2">
            <input type="checkbox" class="form-check-input" id="filter_active_votes">
            <label class="form-check-label" for="filter_active_votes">投票受付中のみ表示</label>
        </div>
        <div class="form-check mb-2">
            <input type="checkbox" class="form-check-input" id="filter_my_surveys">
            <label class="form-check-label" for="filter_my_surveys">自分のアンケートのみ表示</label>
        </div>
    </div>
    {% comment %} チェックボックス ここまで {% endcomment %}
    {% comment %} しほ：タグでの絞り込み機能追加 {% endcomment %}
    <span>タグで絞り込み</span><br>
    {% for tag in all_tags %}
        <label class="me-2">
            <input type="checkbox" name="tag" value="{{ tag.id }}"
                {% if tag.id|stringformat:"s" in selected_tag_ids %}checked{% endif %}>
                {% comment %}
                意味：既に選択されているタグなら、チェックを入れる
                selected_tag_ids はビューで渡した 選択中のタグIDリスト
                tag.id|stringformat:"s" → IDを文字列に変換して比較（GETパラメータは文字列として来るので）
                in selected_tag_ids → このIDがリストに含まれているか確認
                checked → HTML属性でチェックボックスにチェックを入れる
                context["selected_tag_ids"] = self.request.GET.getlist("tag")←これ
                {% endcomment %}
            {{ tag.tag_name }}
        </label>
    {% endfor %}
    </form>
<div class="surveys-list">
    <ul class="list-unstyled">
        {% for survey in survey_list %}
        <li>
            <div class="card mb-3 p-2">
                <div class="selected-tags">
                    {% for tag in survey.tag_survey.all %}
                    <span class="badge bg-secondary">{{ tag.tag_name }}</span>
                    {% empty %}
                    <span class="text-muted">タグなし</span>
                    {% endfor %}
                </div>
                {# 終了：期限切れ or is_open=1（受付終了） #}
                {% if survey.is_expired or survey.is_open == 1 %}
                <div class="title">
                    <h2>
                        <span class="badge bg-secondary m-1">終</span>
                        <a class="h2" href="{% url 'survey-detail' survey.pk %}">{{ survey.title }}</a>
                    </h2>
                </div>
                {% else %}
                {# ★作成者本人なら、受付中でも未投票でも必ず詳細へ #}
                {% if survey.user == request.user %}
                <div class="title">
                    <h2>
                        <span class="badge bg-warning m-1">作</span>
                        <a class="h2" href="{% url 'survey-detail' survey.pk %}">{{ survey.title }}</a>
                    </h2>
                </div>
                {% else %}
                {% if survey.has_voted %}
                {# 受付中 ＋ もう投票済み #}
                <div class="title">
                    <h2>
                        <span class="badge bg-info m-1">済</span>
                        <a class="h2" href="{% url 'survey-detail' survey.pk %}">
                            {{ survey.title }}
                        </a>
                    </h2>
                </div>
                {% else %}
                {# 受付中 ＋ 未投票 → 投票作成へ #}
                <div class="title">
                    <h2>
                        <span class="badge bg-success m-1">受</span>
                        <a class="h2" href="{% url 'vote-create' survey.pk %}">
                            {{ survey.title }}
                        </a>
                    </h2>
                </div>
                {% endif %}
                {% endif %}
                {% endif %}
                <div>
                    {% comment %} <span>23 votes</span> {% endcomment %}
                    <span>{{survey.end_at}}</span>
                </div>
            </div>
        </li>
        {%endfor%}
    </ul>
</div>

{% endblock content %}